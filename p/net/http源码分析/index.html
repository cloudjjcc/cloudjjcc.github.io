<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="golang自带包net/http源码分析"><title>net/http源码分析</title><link rel=canonical href=https://cloudjjcc.github.io/p/net/http%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="net/http源码分析"><meta property="og:description" content="golang自带包net/http源码分析"><meta property="og:url" content="https://cloudjjcc.github.io/p/net/http%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="cloudjjcc's blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="golang"><meta property="article:tag" content="http"><meta property="article:published_time" content="2019-03-11T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-11T00:00:00+00:00"><meta name=twitter:title content="net/http源码分析"><meta name=twitter:description content="golang自带包net/http源码分析"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huafe2357f8150802a98c85f1398684399_3350_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>cloudjjcc's blog</a></h1><h2 class=site-description></h2></div></header><ol class=social-menu><li><a href=https://github.com/cloudjjcc target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#简介>简介</a></li><li><a href=#创建-http-服务>创建 HTTP 服务</a></li><li><a href=#路由管理-servemux>路由管理 ServeMux</a></li><li><a href=#核心服务-server>核心服务 Server</a></li><li><a href=#http-服务实现>HTTP 服务实现</a></li><li><a href=#创建-http-客户端>创建 HTTP 客户端</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/golang/>golang</a>
<a href=/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>源码分析</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/net/http%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>net/http源码分析</a></h2><h3 class=article-subtitle>golang自带包net/http源码分析</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Mar 11, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>18 minute read</time></div></footer></div></header><section class=article-content><h2 id=简介>简介</h2><p><code>net/http</code> 包是 go 语言自带的包，实现了高性能的 http 服务器及 http 客户端，利用这个自带的包能够轻松的进行 web 开发。很多第三方的框架只不过是对此进行了封装，例如 web 框架 gin 主要是强化了路由部分。下面我们就来通过源码对此包进行分析。</p><h2 id=创建-http-服务>创建 HTTP 服务</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 创建httpserver
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注册路由 /demo1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/demo1&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;demo1&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}))</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注册路由 /demo2
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/demo2&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;demo2&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 开启服务，监听 7777端口
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:7777&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的代码完成了一个简单的 http 服务，我们使用了<code>net/http</code> 中的三个方法，<code>http.Handle</code> 、<code>http.HandleFunc</code>、 <code>http.ListenAndServe</code></p><h2 id=路由管理-servemux>路由管理 ServeMux</h2><p>首先，我们来看个接口<code>Handler</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// A Handler responds to an HTTP request.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// ServeHTTP should write reply headers and data to the ResponseWriter
</span></span></span><span class=line><span class=cl><span class=c1>// and then return. Returning signals that the request is finished; it
</span></span></span><span class=line><span class=cl><span class=c1>// is not valid to use the ResponseWriter or read from the
</span></span></span><span class=line><span class=cl><span class=c1>// Request.Body after or concurrently with the completion of the
</span></span></span><span class=line><span class=cl><span class=c1>// ServeHTTP call.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// Depending on the HTTP client software, HTTP protocol version, and
</span></span></span><span class=line><span class=cl><span class=c1>// any intermediaries between the client and the Go server, it may not
</span></span></span><span class=line><span class=cl><span class=c1>// be possible to read from the Request.Body after writing to the
</span></span></span><span class=line><span class=cl><span class=c1>// ResponseWriter. Cautious handlers should read the Request.Body
</span></span></span><span class=line><span class=cl><span class=c1>// first, and then reply.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// Except for reading the body, handlers should not modify the
</span></span></span><span class=line><span class=cl><span class=c1>// provided Request.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// If ServeHTTP panics, the server (the caller of ServeHTTP) assumes
</span></span></span><span class=line><span class=cl><span class=c1>// that the effect of the panic was isolated to the active request.
</span></span></span><span class=line><span class=cl><span class=c1>// It recovers the panic, logs a stack trace to the server error log,
</span></span></span><span class=line><span class=cl><span class=c1>// and either closes the network connection or sends an HTTP/2
</span></span></span><span class=line><span class=cl><span class=c1>// RST_STREAM, depending on the HTTP protocol. To abort a handler so
</span></span></span><span class=line><span class=cl><span class=c1>// the client sees an interrupted response but the server doesn&#39;t log
</span></span></span><span class=line><span class=cl><span class=c1>// an error, panic with the value ErrAbortHandler.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Handler</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>它只有一个 ServeHTTP 的方法，负责处理 http 的请求和响应。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// net/http server.go
</span></span></span><span class=line><span class=cl><span class=c1>// DefaultServeMux is the default ServeMux used by Serve.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>DefaultServeMux</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>defaultServeMux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>defaultServeMux</span> <span class=nx>ServeMux</span>
</span></span><span class=line><span class=cl><span class=c1>// Handle registers the handler for the given pattern
</span></span></span><span class=line><span class=cl><span class=c1>// in the DefaultServeMux.
</span></span></span><span class=line><span class=cl><span class=c1>// The documentation for ServeMux explains how patterns are matched.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Handle</span><span class=p>(</span><span class=nx>pattern</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>Handler</span><span class=p>)</span> <span class=p>{</span> <span class=nx>DefaultServeMux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=nx>pattern</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// HandleFunc registers the handler function for the given pattern
</span></span></span><span class=line><span class=cl><span class=c1>// in the DefaultServeMux.
</span></span></span><span class=line><span class=cl><span class=c1>// The documentation for ServeMux explains how patterns are matched.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>HandleFunc</span><span class=p>(</span><span class=nx>pattern</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>handler</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=o>*</span><span class=nx>Request</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>DefaultServeMux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=nx>pattern</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到<code>http.Handle</code> 和<code>http.HandleFunc</code> 其实都是调用了<code>DefaultServeMux</code>的方法,而<code>DefaultServeMux</code>是<code>ServeMux</code>类型的变量,是<code>net/http</code>包的默认路由管理组件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// net/http server.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ServeMux</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span>    <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span>     <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>muxEntry</span>
</span></span><span class=line><span class=cl>	<span class=nx>es</span>    <span class=p>[]</span><span class=nx>muxEntry</span> <span class=c1>// slice of entries sorted from longest to shortest.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hosts</span> <span class=kt>bool</span>       <span class=c1>// whether any patterns contain hostnames
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>ServeMux</code>是一个结构体，负责路由管理,即：注册和查找路由，下面我们来看它的具体方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Handle registers the handler for the given pattern.
</span></span></span><span class=line><span class=cl><span class=c1>// If a handler already exists for pattern, Handle panics.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>mux</span> <span class=o>*</span><span class=nx>ServeMux</span><span class=p>)</span> <span class=nf>Handle</span><span class=p>(</span><span class=nx>pattern</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>Handler</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mux</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>mux</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pattern</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;http: invalid pattern&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>handler</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;http: nil handler&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exist</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nx>m</span><span class=p>[</span><span class=nx>pattern</span><span class=p>];</span> <span class=nx>exist</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;http: multiple registrations for &#34;</span> <span class=o>+</span> <span class=nx>pattern</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>mux</span><span class=p>.</span><span class=nx>m</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>mux</span><span class=p>.</span><span class=nx>m</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>muxEntry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>e</span> <span class=o>:=</span> <span class=nx>muxEntry</span><span class=p>{</span><span class=nx>h</span><span class=p>:</span> <span class=nx>handler</span><span class=p>,</span> <span class=nx>pattern</span><span class=p>:</span> <span class=nx>pattern</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>mux</span><span class=p>.</span><span class=nx>m</span><span class=p>[</span><span class=nx>pattern</span><span class=p>]</span> <span class=p>=</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pattern</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>pattern</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;/&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>mux</span><span class=p>.</span><span class=nx>es</span> <span class=p>=</span> <span class=nf>appendSorted</span><span class=p>(</span><span class=nx>mux</span><span class=p>.</span><span class=nx>es</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span><span class=c1>//按路由的长度排序后添加到es中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pattern</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=sc>&#39;/&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>mux</span><span class=p>.</span><span class=nx>hosts</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// HandleFunc registers the handler function for the given pattern.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>mux</span> <span class=o>*</span><span class=nx>ServeMux</span><span class=p>)</span> <span class=nf>HandleFunc</span><span class=p>(</span><span class=nx>pattern</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>handler</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=o>*</span><span class=nx>Request</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>handler</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;http: nil handler&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>mux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=nx>pattern</span><span class=p>,</span> <span class=nf>HandlerFunc</span><span class=p>(</span><span class=nx>handler</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的两个函数负责注册路由，其中<code>HandleFunc</code> 将函数类型的参数<code>handler</code>转换成了<code>HandlerFunc</code>类型，再调用<code>Handle</code>函数。注册路由的过程比较简单，路由信息封装到<code>muxEntry</code>结构体中，被保存到了名为<code>m</code>的 map 中，又添加到名为<code>es</code>的切片中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// The HandlerFunc type is an adapter to allow the use of
</span></span></span><span class=line><span class=cl><span class=c1>// ordinary functions as HTTP handlers. If f is a function
</span></span></span><span class=line><span class=cl><span class=c1>// with the appropriate signature, HandlerFunc(f) is a
</span></span></span><span class=line><span class=cl><span class=c1>// Handler that calls f.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>HandlerFunc</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ServeHTTP calls f(w, r).
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=nx>HandlerFunc</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span> <span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>f</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可见，<code>HandlerFunc</code>是一个实现了<code>Handler</code>接口的函数类型。</p><p>下面我们继续看 ServeMux 查找路由的方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ServeHTTP dispatches the request to the handler whose
</span></span></span><span class=line><span class=cl><span class=c1>// pattern most closely matches the request URL.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>mux</span> <span class=o>*</span><span class=nx>ServeMux</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span> <span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>RequestURI</span> <span class=o>==</span> <span class=s>&#34;*&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nf>ProtoAtLeast</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Connection&#34;</span><span class=p>,</span> <span class=s>&#34;close&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>Handler</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Handler returns the handler to use for the given request,
</span></span></span><span class=line><span class=cl><span class=c1>// consulting r.Method, r.Host, and r.URL.Path. It always returns
</span></span></span><span class=line><span class=cl><span class=c1>// a non-nil handler. If the path is not in its canonical form, the
</span></span></span><span class=line><span class=cl><span class=c1>// handler will be an internally-generated handler that redirects
</span></span></span><span class=line><span class=cl><span class=c1>// to the canonical path. If the host contains a port, it is ignored
</span></span></span><span class=line><span class=cl><span class=c1>// when matching handlers.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// The path and host are used unchanged for CONNECT requests.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// Handler also returns the registered pattern that matches the
</span></span></span><span class=line><span class=cl><span class=c1>// request or, in the case of internally-generated redirects,
</span></span></span><span class=line><span class=cl><span class=c1>// the pattern that will match after following the redirect.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// If there is no registered handler that applies to the request,
</span></span></span><span class=line><span class=cl><span class=c1>// Handler returns a ``page not found&#39;&#39; handler and an empty pattern.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>mux</span> <span class=o>*</span><span class=nx>ServeMux</span><span class=p>)</span> <span class=nf>Handler</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>Handler</span><span class=p>,</span> <span class=nx>pattern</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// CONNECT requests are not canonicalized.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=s>&#34;CONNECT&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// If r.URL.Path is /tree and its handler is not registered,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// the /tree -&gt; /tree/ redirect applies to CONNECT requests
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// but the path canonicalization does not.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>u</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>redirectToPathSlash</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Host</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nf>RedirectHandler</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>StatusMovedPermanently</span><span class=p>),</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Path</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>handler</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Host</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// All other requests have any port stripped and path cleaned
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// before passing to mux.handler.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>host</span> <span class=o>:=</span> <span class=nf>stripHostPort</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>path</span> <span class=o>:=</span> <span class=nf>cleanPath</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If the given path is /tree and its handler is not registered,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// redirect for /tree/.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>u</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>redirectToPathSlash</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nf>RedirectHandler</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>StatusMovedPermanently</span><span class=p>),</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Path</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>path</span> <span class=o>!=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>pattern</span> <span class=p>=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>handler</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>url</span> <span class=o>:=</span> <span class=o>*</span><span class=nx>r</span><span class=p>.</span><span class=nx>URL</span>
</span></span><span class=line><span class=cl>		<span class=nx>url</span><span class=p>.</span><span class=nx>Path</span> <span class=p>=</span> <span class=nx>path</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nf>RedirectHandler</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>StatusMovedPermanently</span><span class=p>),</span> <span class=nx>pattern</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>handler</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// handler is the main implementation of Handler.
</span></span></span><span class=line><span class=cl><span class=c1>// The path is known to be in canonical form, except for CONNECT methods.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>mux</span> <span class=o>*</span><span class=nx>ServeMux</span><span class=p>)</span> <span class=nf>handler</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>path</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>Handler</span><span class=p>,</span> <span class=nx>pattern</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mux</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>mux</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Host-specific pattern takes precedence over generic ones
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>mux</span><span class=p>.</span><span class=nx>hosts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>,</span> <span class=nx>pattern</span> <span class=p>=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>match</span><span class=p>(</span><span class=nx>host</span> <span class=o>+</span> <span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>h</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>,</span> <span class=nx>pattern</span> <span class=p>=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>match</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>h</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>,</span> <span class=nx>pattern</span> <span class=p>=</span> <span class=nf>NotFoundHandler</span><span class=p>(),</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面代码展示了<code>ServeMux</code>的三个方法<code>ServeHTTP</code>、<code>Handler</code>、<code>handler</code>,可见<code>ServeMux</code>实现了<code>Handler</code>接口，</p><p><code>ServeHTTP</code> 方法是路由服务的入口点，层层调用<code>Handler</code>、<code>handler</code>方法，在<code>handler</code>方法中最终调用<code>match</code>方法进行路由匹配得到路由对应的<code>Handler</code>然后执行<code>Handler</code>的<code>ServeHTTP</code>方法,可见<code>Handler</code>既可以是一个确定的路由，也可以是一个路由管理器。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Find a handler on a handler map given a path string.
</span></span></span><span class=line><span class=cl><span class=c1>// Most-specific (longest) pattern wins.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>mux</span> <span class=o>*</span><span class=nx>ServeMux</span><span class=p>)</span> <span class=nf>match</span><span class=p>(</span><span class=nx>path</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>h</span> <span class=nx>Handler</span><span class=p>,</span> <span class=nx>pattern</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Check for exact match first.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nx>m</span><span class=p>[</span><span class=nx>path</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>v</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span> <span class=nx>v</span><span class=p>.</span><span class=nx>pattern</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check for longest valid match.  mux.es contains all patterns
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// that end in / sorted from longest to shortest.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>mux</span><span class=p>.</span><span class=nx>es</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>HasPrefix</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>pattern</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>e</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>pattern</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>路由查找分为两步：</p><ol><li>map 查找</li><li>分片查找</li></ol><p>map 查找是完全匹配，若查找不到，则到分片中根据前缀匹配，因为分片是按长到短排序的，所以找到的是匹配前缀最长的<code>Handler</code></p><h2 id=核心服务-server>核心服务 Server</h2><p>下面我们来看<code>http.ListenAndServe</code>函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ListenAndServe listens on the TCP network address addr and then calls
</span></span></span><span class=line><span class=cl><span class=c1>// Serve with handler to handle requests on incoming connections.
</span></span></span><span class=line><span class=cl><span class=c1>// Accepted connections are configured to enable TCP keep-alives.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// The handler is typically nil, in which case the DefaultServeMux is used.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// ListenAndServe always returns a non-nil error.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ListenAndServe</span><span class=p>(</span><span class=nx>addr</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>handler</span> <span class=nx>Handler</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Server</span><span class=p>{</span><span class=nx>Addr</span><span class=p>:</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>Handler</span><span class=p>:</span> <span class=nx>handler</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>server</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>该函数创建了<code>Server</code>结构体变量，然后调用了<code>server</code>的<code>ListenAndServe</code>方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// A Server defines parameters for running an HTTP server.
</span></span></span><span class=line><span class=cl><span class=c1>// The zero value for Server is a valid configuration.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Server</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Addr</span>    <span class=kt>string</span>  <span class=c1>// TCP address to listen on, &#34;:http&#34; if empty
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Handler</span> <span class=nx>Handler</span> <span class=c1>// handler to invoke, http.DefaultServeMux if nil
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// TLSConfig optionally provides a TLS configuration for use
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by ServeTLS and ListenAndServeTLS. Note that this value is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// cloned by ServeTLS and ListenAndServeTLS, so it&#39;s not
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// possible to modify the configuration with methods like
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// tls.Config.SetSessionTicketKeys. To use
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// SetSessionTicketKeys, use Server.Serve with a TLS Listener
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// instead.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>TLSConfig</span> <span class=o>*</span><span class=nx>tls</span><span class=p>.</span><span class=nx>Config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ReadTimeout is the maximum duration for reading the entire
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// request, including the body.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Because ReadTimeout does not let Handlers make per-request
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// decisions on each request body&#39;s acceptable deadline or
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// upload rate, most users will prefer to use
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ReadHeaderTimeout. It is valid to use them both.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ReadTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ReadHeaderTimeout is the amount of time allowed to read
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// request headers. The connection&#39;s read deadline is reset
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// after reading the headers and the Handler can decide what
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// is considered too slow for the body. If ReadHeaderTimeout
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// is zero, the value of ReadTimeout is used. If both are
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// zero, there is no timeout.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ReadHeaderTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// WriteTimeout is the maximum duration before timing out
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// writes of the response. It is reset whenever a new
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// request&#39;s header is read. Like ReadTimeout, it does not
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// let Handlers make decisions on a per-request basis.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>WriteTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// IdleTimeout is the maximum amount of time to wait for the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// next request when keep-alives are enabled. If IdleTimeout
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// is zero, the value of ReadTimeout is used. If both are
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// zero, there is no timeout.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>IdleTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// MaxHeaderBytes controls the maximum number of bytes the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// server will read parsing the request header&#39;s keys and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// values, including the request line. It does not limit the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// size of the request body.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If zero, DefaultMaxHeaderBytes is used.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>MaxHeaderBytes</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// TLSNextProto optionally specifies a function to take over
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ownership of the provided TLS connection when an NPN/ALPN
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// protocol upgrade has occurred. The map key is the protocol
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// name negotiated. The Handler argument should be used to
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// handle HTTP requests and will initialize the Request&#39;s TLS
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and RemoteAddr if not already set. The connection is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// automatically closed when the function returns.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If TLSNextProto is not nil, HTTP/2 support is not enabled
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// automatically.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>TLSNextProto</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>Server</span><span class=p>,</span> <span class=o>*</span><span class=nx>tls</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=nx>Handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ConnState specifies an optional callback function that is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// called when a client connection changes state. See the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ConnState type and associated constants for details.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ConnState</span> <span class=kd>func</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=nx>ConnState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ErrorLog specifies an optional logger for errors accepting
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// connections, unexpected behavior from handlers, and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// underlying FileSystem errors.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If nil, logging is done via the log package&#39;s standard logger.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ErrorLog</span> <span class=o>*</span><span class=nx>log</span><span class=p>.</span><span class=nx>Logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// BaseContext optionally specifies a function that returns
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// the base context for incoming requests on this server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The provided Listener is the specific Listener that&#39;s
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// about to start accepting requests.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If BaseContext is nil, the default is context.Background().
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If non-nil, it must return a non-nil context.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>BaseContext</span> <span class=kd>func</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>)</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ConnContext optionally specifies a function that modifies
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// the context used for a new connection c. The provided ctx
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// is derived from the base context and has a ServerContextKey
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// value.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ConnContext</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>c</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>disableKeepAlives</span> <span class=kt>int32</span>     <span class=c1>// accessed atomically.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>inShutdown</span>        <span class=kt>int32</span>     <span class=c1>// accessed atomically (non-zero means we&#39;re in Shutdown)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nextProtoOnce</span>     <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span> <span class=c1>// guards setupHTTP2_* init
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nextProtoErr</span>      <span class=kt>error</span>     <span class=c1>// result of http2.ConfigureServer if used
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span>         <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>listeners</span>  <span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>]</span><span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>activeConn</span> <span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>conn</span><span class=p>]</span><span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>doneChan</span>   <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>onShutdown</span> <span class=p>[]</span><span class=kd>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// ListenAndServe listens on the TCP network address srv.Addr and then
</span></span></span><span class=line><span class=cl><span class=c1>// calls Serve to handle requests on incoming connections.
</span></span></span><span class=line><span class=cl><span class=c1>// Accepted connections are configured to enable TCP keep-alives.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// If srv.Addr is blank, &#34;:http&#34; is used.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// ListenAndServe always returns a non-nil error. After Shutdown or Close,
</span></span></span><span class=line><span class=cl><span class=c1>// the returned error is ErrServerClosed.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>ListenAndServe</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>shuttingDown</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ErrServerClosed</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>addr</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>Addr</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>addr</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>addr</span> <span class=p>=</span> <span class=s>&#34;:http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>ln</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>ln</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到<code>ListenAndServe</code>方法监听了<code>tcp</code>套接字，并将<code>listener</code>作为<code>Serve</code>方法的参数进行调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Serve accepts incoming connections on the Listener l, creating a
</span></span></span><span class=line><span class=cl><span class=c1>// new service goroutine for each. The service goroutines read requests and
</span></span></span><span class=line><span class=cl><span class=c1>// then call srv.Handler to reply to them.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// HTTP/2 support is only enabled if the Listener returns *tls.Conn
</span></span></span><span class=line><span class=cl><span class=c1>// connections and they were configured with &#34;h2&#34; in the TLS
</span></span></span><span class=line><span class=cl><span class=c1>// Config.NextProtos.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// Serve always returns a non-nil error and closes l.
</span></span></span><span class=line><span class=cl><span class=c1>// After Shutdown or Close, the returned error is ErrServerClosed.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>Serve</span><span class=p>(</span><span class=nx>l</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>fn</span> <span class=o>:=</span> <span class=nx>testHookServerServe</span><span class=p>;</span> <span class=nx>fn</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fn</span><span class=p>(</span><span class=nx>srv</span><span class=p>,</span> <span class=nx>l</span><span class=p>)</span> <span class=c1>// call hook with unwrapped listener
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>origListener</span> <span class=o>:=</span> <span class=nx>l</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>onceCloseListener</span><span class=p>{</span><span class=nx>Listener</span><span class=p>:</span> <span class=nx>l</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>l</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>setupHTTP2_Serve</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>srv</span><span class=p>.</span><span class=nf>trackListener</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ErrServerClosed</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>trackListener</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>tempDelay</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=c1>// how long to sleep on accept failure
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>baseCtx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>BaseContext</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>baseCtx</span> <span class=p>=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>BaseContext</span><span class=p>(</span><span class=nx>origListener</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>baseCtx</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;BaseContext returned a nil context&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>baseCtx</span><span class=p>,</span> <span class=nx>ServerContextKey</span><span class=p>,</span> <span class=nx>srv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rw</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>Accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>srv</span><span class=p>.</span><span class=nf>getDoneChan</span><span class=p>():</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>ErrServerClosed</span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ne</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.(</span><span class=nx>net</span><span class=p>.</span><span class=nx>Error</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>ne</span><span class=p>.</span><span class=nf>Temporary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>tempDelay</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tempDelay</span> <span class=p>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tempDelay</span> <span class=o>*=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>max</span> <span class=o>:=</span> <span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>;</span> <span class=nx>tempDelay</span> <span class=p>&gt;</span> <span class=nx>max</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tempDelay</span> <span class=p>=</span> <span class=nx>max</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>srv</span><span class=p>.</span><span class=nf>logf</span><span class=p>(</span><span class=s>&#34;http: Accept error: %v; retrying in %v&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>,</span> <span class=nx>tempDelay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>tempDelay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>cc</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>ConnContext</span><span class=p>;</span> <span class=nx>cc</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ctx</span> <span class=p>=</span> <span class=nf>cc</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>rw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ctx</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;ConnContext returned nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>tempDelay</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>newConn</span><span class=p>(</span><span class=nx>rw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=nx>StateNew</span><span class=p>)</span> <span class=c1>// before Serve can return
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>go</span> <span class=nx>c</span><span class=p>.</span><span class=nf>serve</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的代码完成了一个典型的 TCP 服务器，在 for 循环中处理连接，每获得一个新的连接就开一个新的协程去处理。这里的连接进一步封装了<code>net.Conn</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// A conn represents the server side of an HTTP connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>conn</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// server is the server on which the connection arrived.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Immutable; never nil.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>server</span> <span class=o>*</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// cancelCtx cancels the connection-level context.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cancelCtx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>CancelFunc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// rwc is the underlying network connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is never wrapped by other types and is the value given out
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to CloseNotifier callers. It is usually of type *net.TCPConn or
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// *tls.Conn.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rwc</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// remoteAddr is rwc.RemoteAddr().String(). It is not populated synchronously
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// inside the Listener&#39;s Accept goroutine, as some implementations block.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It is populated immediately inside the (*conn).serve goroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is the value of a Handler&#39;s (*Request).RemoteAddr.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>remoteAddr</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// tlsState is the TLS connection state when using TLS.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// nil means not TLS.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tlsState</span> <span class=o>*</span><span class=nx>tls</span><span class=p>.</span><span class=nx>ConnectionState</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// werr is set to the first write error to rwc.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It is set via checkConnErrorWriter{w}, where bufw writes.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>werr</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// r is bufr&#39;s read source. It&#39;s a wrapper around rwc that provides
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// io.LimitedReader-style limiting (while reading request headers)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and functionality to support CloseNotifier. See *connReader docs.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>r</span> <span class=o>*</span><span class=nx>connReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// bufr reads from r.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bufr</span> <span class=o>*</span><span class=nx>bufio</span><span class=p>.</span><span class=nx>Reader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// bufw writes to checkConnErrorWriter{c}, which populates werr on error.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bufw</span> <span class=o>*</span><span class=nx>bufio</span><span class=p>.</span><span class=nx>Writer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// lastMethod is the method of the most recent request
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// on this connection, if any.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lastMethod</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>curReq</span> <span class=nx>atomic</span><span class=p>.</span><span class=nx>Value</span> <span class=c1>// of *response (which has a Request in it)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>curState</span> <span class=kd>struct</span><span class=p>{</span> <span class=nx>atomic</span> <span class=kt>uint64</span> <span class=p>}</span> <span class=c1>// packed (unixtime&lt;&lt;8|uint8(ConnState))
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// mu guards hijackedv
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// hijackedv is whether this connection has been hijacked
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by a Handler with the Hijacker interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It is guarded by mu.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hijackedv</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=http-服务实现>HTTP 服务实现</h2><p>具体的连接处理也是完整的<code>HTTP</code> 服务实现在<code>conn</code>结构体<code>serve</code>方法中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Serve a new connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>conn</span><span class=p>)</span> <span class=nf>serve</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>remoteAddr</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>RemoteAddr</span><span class=p>().</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>LocalAddrContextKey</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>LocalAddr</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>ErrAbortHandler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>const</span> <span class=nx>size</span> <span class=p>=</span> <span class=mi>64</span> <span class=o>&lt;&lt;</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>			<span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>buf</span> <span class=p>=</span> <span class=nx>buf</span><span class=p>[:</span><span class=nx>runtime</span><span class=p>.</span><span class=nf>Stack</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=kc>false</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>logf</span><span class=p>(</span><span class=s>&#34;http: panic serving %v: %v\n%s&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>remoteAddr</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>c</span><span class=p>.</span><span class=nf>hijacked</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nb>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=nx>StateClosed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>tlsConn</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.(</span><span class=o>*</span><span class=nx>tls</span><span class=p>.</span><span class=nx>Conn</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>d</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nx>ReadTimeout</span><span class=p>;</span> <span class=nx>d</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetReadDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>d</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nx>WriteTimeout</span><span class=p>;</span> <span class=nx>d</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetWriteDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tlsConn</span><span class=p>.</span><span class=nf>Handshake</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// If the handshake failed due to the client not speaking
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// TLS, assume they&#39;re speaking plaintext HTTP and write a
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 400 response on the TLS conn&#39;s underlying net.Conn.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>re</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>tls</span><span class=p>.</span><span class=nx>RecordHeaderError</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>re</span><span class=p>.</span><span class=nx>Conn</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nf>tlsRecordHeaderLooksLikeHTTP</span><span class=p>(</span><span class=nx>re</span><span class=p>.</span><span class=nx>RecordHeader</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>io</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nx>re</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=s>&#34;HTTP/1.0 400 Bad Request\r\n\r\nClient sent an HTTP request to an HTTPS server.\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>re</span><span class=p>.</span><span class=nx>Conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>logf</span><span class=p>(</span><span class=s>&#34;http: TLS handshake error from %s: %v&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>RemoteAddr</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>tlsState</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>tls</span><span class=p>.</span><span class=nx>ConnectionState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=nx>c</span><span class=p>.</span><span class=nx>tlsState</span> <span class=p>=</span> <span class=nx>tlsConn</span><span class=p>.</span><span class=nf>ConnectionState</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>proto</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>tlsState</span><span class=p>.</span><span class=nx>NegotiatedProtocol</span><span class=p>;</span> <span class=nf>validNPN</span><span class=p>(</span><span class=nx>proto</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>fn</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nx>TLSNextProto</span><span class=p>[</span><span class=nx>proto</span><span class=p>];</span> <span class=nx>fn</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>h</span> <span class=o>:=</span> <span class=nx>initNPNRequest</span><span class=p>{</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>tlsConn</span><span class=p>,</span> <span class=nx>serverHandler</span><span class=p>{</span><span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>				<span class=nf>fn</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>,</span> <span class=nx>tlsConn</span><span class=p>,</span> <span class=nx>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// HTTP/1.x from here on.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancelCtx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>cancelCtx</span> <span class=p>=</span> <span class=nx>cancelCtx</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancelCtx</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>r</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>connReader</span><span class=p>{</span><span class=nx>conn</span><span class=p>:</span> <span class=nx>c</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>bufr</span> <span class=p>=</span> <span class=nf>newBufioReader</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>bufw</span> <span class=p>=</span> <span class=nf>newBufioWriterSize</span><span class=p>(</span><span class=nx>checkConnErrorWriter</span><span class=p>{</span><span class=nx>c</span><span class=p>},</span> <span class=mi>4</span><span class=o>&lt;&lt;</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>readRequest</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nx>remain</span> <span class=o>!=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>initialReadLimitSize</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// If we read any bytes off the wire, we&#39;re active.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>c</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=nx>StateActive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>const</span> <span class=nx>errorHeaders</span> <span class=p>=</span> <span class=s>&#34;\r\nContent-Type: text/plain; charset=utf-8\r\nConnection: close\r\n\r\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>errTooLarge</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Their HTTP client may or may not be
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// able to read this if we&#39;re
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// responding to them and hanging up
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// while they&#39;re still writing their
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// request. Undefined behavior.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=kd>const</span> <span class=nx>publicErr</span> <span class=p>=</span> <span class=s>&#34;431 Request Header Fields Too Large&#34;</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=s>&#34;HTTP/1.1 &#34;</span><span class=o>+</span><span class=nx>publicErr</span><span class=o>+</span><span class=nx>errorHeaders</span><span class=o>+</span><span class=nx>publicErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>closeWriteAndWait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nf>isUnsupportedTEError</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Respond as per RFC 7230 Section 3.3.1 which says,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>//      A server that receives a request message with a
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>//      transfer coding it does not understand SHOULD
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>//      respond with 501 (Unimplemented).
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>code</span> <span class=o>:=</span> <span class=nx>StatusNotImplemented</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// We purposefully aren&#39;t echoing back the transfer-encoding&#39;s value,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// so as to mitigate the risk of cross side scripting by an attacker.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=s>&#34;HTTP/1.1 %d %s%sUnsupported transfer encoding&#34;</span><span class=p>,</span> <span class=nx>code</span><span class=p>,</span> <span class=nf>StatusText</span><span class=p>(</span><span class=nx>code</span><span class=p>),</span> <span class=nx>errorHeaders</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nf>isCommonNetReadError</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=c1>// don&#39;t reply
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>publicErr</span> <span class=o>:=</span> <span class=s>&#34;400 Bad Request&#34;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>badRequestError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>publicErr</span> <span class=p>=</span> <span class=nx>publicErr</span> <span class=o>+</span> <span class=s>&#34;: &#34;</span> <span class=o>+</span> <span class=nb>string</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=s>&#34;HTTP/1.1 &#34;</span><span class=o>+</span><span class=nx>publicErr</span><span class=o>+</span><span class=nx>errorHeaders</span><span class=o>+</span><span class=nx>publicErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Expect 100 Continue support
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>req</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>req</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>expectsContinue</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>ProtoAtLeast</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>req</span><span class=p>.</span><span class=nx>ContentLength</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Wrap the Body reader with one that replies on the connection
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>req</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>expectContinueReader</span><span class=p>{</span><span class=nx>readCloser</span><span class=p>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span> <span class=nx>resp</span><span class=p>:</span> <span class=nx>w</span><span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=s>&#34;Expect&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span><span class=p>.</span><span class=nf>sendExpectationFailed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>curReq</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nf>requestBodyRemains</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>registerOnHitEOF</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nx>startBackgroundRead</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nf>startBackgroundRead</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// HTTP cannot have multiple simultaneous active requests.[*]
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// Until the server replies to this request, it can&#39;t read another,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// so we might as well run the handler in this goroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// [*] Not strictly true: HTTP pipelining. We could let them all process
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// in parallel even if their responses need to be serialized.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// But we&#39;re not going to implement HTTP pipelining because it
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// was never deployed in the wild and the answer is HTTP/2.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>serverHandler</span><span class=p>{</span><span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>}.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>cancelCtx</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nf>hijacked</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>finishRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>w</span><span class=p>.</span><span class=nf>shouldReuseConnection</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>requestBodyLimitHit</span> <span class=o>||</span> <span class=nx>w</span><span class=p>.</span><span class=nf>closedRequestBodyEarly</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>closeWriteAndWait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=nx>StateIdle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>curReq</span><span class=p>.</span><span class=nf>Store</span><span class=p>((</span><span class=o>*</span><span class=nx>response</span><span class=p>)(</span><span class=kc>nil</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>doKeepAlives</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// We&#39;re in shutdown mode. We might&#39;ve replied
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// to the user without &#34;Connection: close&#34; and
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// they might think they can send another
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// request, but such is life with HTTP/1.1.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>d</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>idleTimeout</span><span class=p>();</span> <span class=nx>d</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetReadDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>bufr</span><span class=p>.</span><span class=nf>Peek</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetReadDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=创建-http-客户端>创建 HTTP 客户端</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;http://www.baidu.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以直接直接使用<code>http.Get</code>或<code>http.Post</code>发送请求</p></section><footer class=article-footer><section class=article-tags><a href=/tags/golang/>golang</a>
<a href=/tags/http/>http</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/go%E7%A8%8B%E5%BA%8F%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA/><div class=article-details><h2 class=article-title>go程序优雅退出</h2></div></a></article><article><a href=/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/><div class=article-details><h2 class=article-title>go 常用数据结构</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=cloudjjcc/cloudjjcc.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyMzAzOTgyODU=" data-category=Announcements data-category-id=DIC_kwDODbuZTc4CZbH_ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2019 -
2023 cloudjjcc</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>