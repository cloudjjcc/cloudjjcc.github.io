<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="go 常用数据结构（array,slice,string,map）"><title>go 常用数据结构</title><link rel=canonical href=https://cloudjjcc.github.io/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="go 常用数据结构"><meta property="og:description" content="go 常用数据结构（array,slice,string,map）"><meta property="og:url" content="https://cloudjjcc.github.io/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><meta property="og:site_name" content="cloudjjcc's blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="golang"><meta property="article:tag" content="array"><meta property="article:tag" content="slice"><meta property="article:tag" content="string"><meta property="article:tag" content="map"><meta property="article:published_time" content="2019-02-05T00:00:00+00:00"><meta property="article:modified_time" content="2019-02-05T00:00:00+00:00"><meta name=twitter:title content="go 常用数据结构"><meta name=twitter:description content="go 常用数据结构（array,slice,string,map）"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huafe2357f8150802a98c85f1398684399_3350_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>cloudjjcc's blog</a></h1><h2 class=site-description></h2></div></header><ol class=social-menu><li><a href=https://github.com/cloudjjcc target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#array>array</a></li><li><a href=#slice>slice</a><ol><li><a href=#初始化>初始化</a><ol><li><a href=#直接使用>直接使用</a></li><li><a href=#通过字面量初始化>通过字面量初始化</a></li><li><a href=#通过-make-初始化切片>通过 <code>make</code> 初始化切片</a></li><li><a href=#下标操作>下标操作</a></li></ol></li><li><a href=#扩容>扩容</a></li></ol></li><li><a href=#string>string</a><ol><li><a href=#字符串的字面量形式>字符串的字面量形式</a></li><li><a href=#字符串类型转化>字符串类型转化</a></li><li><a href=#字符串的拼接>字符串的拼接</a></li></ol></li><li><a href=#map>map</a><ol><li><a href=#初始化-1>初始化</a><ol><li><a href=#字面量初始化>字面量初始化</a></li><li><a href=#make初始化><code>make</code>初始化</a></li></ol></li><li><a href=#访问>访问</a></li><li><a href=#遍历>遍历</a></li><li><a href=#写入>写入</a></li><li><a href=#删除>删除</a></li><li><a href=#扩容-1>扩容</a></li></ol></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/golang/>golang</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>go 常用数据结构</a></h2><h3 class=article-subtitle>go 常用数据结构（array,slice,string,map）</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 05, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><h2 id=array>array</h2><p>在 Go 语言中我们通过如下方式声明数组类型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>[</span><span class=mi>5</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>10</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>数组类型包含数组长度以及元素类型，长度不同或者元素类型不同的数组是不同类型的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>a</span> <span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span> <span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span> <span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>d</span> <span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;a type:%T,b type:%T,c type:%T,d type:%T\n&#34;</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>c</span><span class=p>,</span> <span class=nx>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// a type:[2]int,b type:[3]int,c type:[2]interface {},d type:[3]interface {}
</span></span></span></code></pre></td></tr></table></div></div><p>数组长度可以根据字面量进行推导,可以通过下面的方式初始化数组，编译时会自动推导数组长度</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>e</span> <span class=o>:=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%T\n&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// [3]int
</span></span></span></code></pre></td></tr></table></div></div><p>可以通过内置函数<code>len</code> 获取数组长度</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>f</span> <span class=o>:=</span> <span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=kt>int</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;len:%d,cap:%d\n&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>f</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// len:8,cap:8
</span></span></span></code></pre></td></tr></table></div></div><h2 id=slice>slice</h2><p>切片是变长数组的实现方案，切片类型如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ss</span> <span class=p>[]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%T\n&#34;</span><span class=p>,</span> <span class=nx>ss</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// []int
</span></span></span></code></pre></td></tr></table></div></div><p>运行时结构为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>slice</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>array</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>//指向底层数组的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>len</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>cap</span>   <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可通过内置函数 <code>len</code> 获取长度，<code>cap</code> 获取容量,<code>append</code>进行元素追加</p><h3 id=初始化>初始化</h3><h4 id=直接使用>直接使用</h4><p>未初始化的切片等于<code>nil</code>,可以直接使用。因为切片实际上是一个结构体，声明一个切片时，所有字段初始化为零值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ss</span> <span class=p>[]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%p,%p,%d,%d,%t\n&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>ss</span><span class=p>,</span> <span class=nx>ss</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ss</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>ss</span><span class=p>),</span> <span class=nx>ss</span> <span class=o>==</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>ss</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>ss</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%p,%p,%d,%d\n&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>ss</span><span class=p>,</span> <span class=nx>ss</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ss</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>ss</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// 0xc0001346d8,0x0,0,0,true
</span></span></span><span class=line><span class=cl><span class=c1>// 0xc0001346d8,0xc00012a738,1,1
</span></span></span></code></pre></td></tr></table></div></div><p>注意：当我们使用 <code>%p</code> 打印切片时，打印的实际上是底层数组的地址</p><h4 id=通过字面量初始化>通过字面量初始化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>s</span><span class=o>:=</span><span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=通过-make-初始化切片>通过 <code>make</code> 初始化切片</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>s6</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%p,%d,%d\n&#34;</span><span class=p>,</span> <span class=nx>s6</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s6</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>s6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// 0xc00002c210,2,6
</span></span></span></code></pre></td></tr></table></div></div><p><code>make</code> 操作在编译时会根据切片大小、容量以及是否发生逃逸，来决定行为:</p><ul><li>当切片足够小且没有发生逃逸时会直接分配数组，然后对数组进行切片操作获得切片</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>arr</span> <span class=p>[</span><span class=mi>4</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nx>s</span> <span class=o>:=</span> <span class=nx>arr</span><span class=p>[:]</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>否则转化为对<code>runtime.makeslice</code>调用在堆上分配</li></ul><h4 id=下标操作>下标操作</h4><p>可以通过下标操作<code>s[a:b:c]</code>从已有数组或切片获取一个新的切片，新的切片共享底层数组,操作中 a 不指定默认为 0，b 不指定默认为 len(s),c 不指定默认为 cap(s),新生成的切片 len=b-a,cap=c-a</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>a</span> <span class=o>:=</span> <span class=p>[</span><span class=mi>5</span><span class=p>]</span><span class=kt>int</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;addr:%p,len:%d,cap:%d\n&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>a</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>a</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>a</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>s1</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>[:]</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;addr:%p,len:%d,cap:%d\n&#34;</span><span class=p>,</span> <span class=nx>s1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s1</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>s1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>s2</span> <span class=o>:=</span> <span class=nx>s1</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;addr:%p,len:%d,cap:%d\n&#34;</span><span class=p>,</span> <span class=nx>s2</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s2</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>s2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>s3</span> <span class=o>:=</span> <span class=nx>s1</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;addr:%p,len:%d,cap:%d\n&#34;</span><span class=p>,</span> <span class=nx>s3</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s3</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>s3</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>s4</span> <span class=o>:=</span> <span class=nx>s1</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>2</span><span class=p>:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;addr:%p,len:%d,cap:%d\n&#34;</span><span class=p>,</span> <span class=nx>s4</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s4</span><span class=p>),</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>s4</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>//addr:0xc00002c240,len:5,cap:5
</span></span></span><span class=line><span class=cl><span class=c1>//addr:0xc00002c240,len:5,cap:5
</span></span></span><span class=line><span class=cl><span class=c1>//addr:0xc00002c248,len:4,cap:4
</span></span></span><span class=line><span class=cl><span class=c1>//addr:0xc00002c248,len:1,cap:4
</span></span></span><span class=line><span class=cl><span class=c1>//addr:0xc00002c248,len:1,cap:2
</span></span></span></code></pre></td></tr></table></div></div><h3 id=扩容>扩容</h3><p>当通过<code>append</code>操作追加元素时，元素数量超过切片的容量时，切片会发生扩容。
扩容操作本质上是开辟一个新的容量足够大的数组，将原来的数组元素复制到新数组，将切片的数组指针指向新数组，新数组的容量选取需要考虑两方面的因素：</p><ul><li>扩容操作会涉及到内存拷贝，是一个比较耗时的操作，所以需要尽可能减少扩容发生的概率</li><li>尽量避免内存浪费，新分配的内存尽可能多的使用，原有的内存能够有效的回收</li></ul><p>基于以上考虑，运行时根据切片的当期容量选择不同扩容策略：</p><ul><li>如果期望容量大于当前容量的两倍就会使用期望容量；</li><li>如果当前切片的长度小于 1024 就会将容量翻倍；</li><li>如果当前切片的长度大于 1024 就会每次增加 25% 的容量，直到新容量大于期望容量；</li></ul><h2 id=string>string</h2><p>运行时结构如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>stringStruct</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>str</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>//指向[]byte的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>len</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=字符串的字面量形式>字符串的字面量形式</h3><ul><li>双引号</li><li>反引号</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>s</span><span class=o>:=</span><span class=s>&#34;hello world&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>s1</span><span class=o>:=</span><span class=s>`a
</span></span></span><span class=line><span class=cl><span class=s>b
</span></span></span><span class=line><span class=cl><span class=s>`</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=字符串类型转化>字符串类型转化</h3><ul><li><code>string</code> 和 <code>[]byte</code>
标准类型转换</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>a</span><span class=o>:=</span><span class=s>&#34;hello world&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=o>:=</span><span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=o>:=</span><span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>实际上调用了<code>runtime.stringtoslicebyte</code> 和<code>runtime.slicebytetostring</code>函数
会进行内存拷贝</p><p>可以通过指针类型转换来避免内存拷贝</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// string to slice no copy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>a</span><span class=o>:=</span><span class=s>&#34;abcde&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>s</span> <span class=o>:=</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=nx>reflect</span><span class=p>.</span><span class=nx>SliceHeader</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>a</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>s</span><span class=p>.</span><span class=nx>Cap</span><span class=p>=</span><span class=nb>len</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>d</span><span class=o>:=*</span><span class=p>(</span><span class=o>*</span><span class=p>[]</span><span class=kt>byte</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// slice to string no copy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>b</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;abcde&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>e</span> <span class=o>:=</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>string</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>b</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>注意：通过指针将一个<code>string</code>转为<code>slice</code>后应该避免修改，否则会报异常，因为<code>string</code> 字面量是只读的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>d</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>=</span> <span class=sc>&#39;j&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>// ouput
</span></span></span><span class=line><span class=cl><span class=c1>// unexpected fault address 0x15cfe93
</span></span></span><span class=line><span class=cl><span class=c1>// fatal error: fault
</span></span></span></code></pre></td></tr></table></div></div><ul><li><code>string</code> 和 <code>[]rune</code>
标准类型转换</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>aa</span> <span class=o>:=</span> <span class=s>&#34;hello world&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>bb</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>rune</span><span class=p>(</span><span class=nx>aa</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>cc</span> <span class=o>:=</span> <span class=nb>string</span><span class=p>(</span><span class=nx>bb</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>底层会调用<code>runtime.stringtoslicerune</code> 和 <code>runtime.slicerunetostring</code> 函数</p><h3 id=字符串的拼接>字符串的拼接</h3><ul><li>通过<code>+</code>进行拼接</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>a</span><span class=o>:=</span> <span class=s>&#34;hello&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=o>:=</span><span class=s>&#34;world&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>c</span><span class=o>:=</span><span class=nx>a</span><span class=o>+</span><span class=s>&#34; &#34;</span><span class=o>+</span><span class=nx>b</span>
</span></span></code></pre></td></tr></table></div></div><p>编译器会转化为对<code>runtime.concatstrings</code>函数的调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// concatstrings implements a Go string concatenation x+y+z+...
</span></span></span><span class=line><span class=cl><span class=c1>// The operands are passed in the slice a.
</span></span></span><span class=line><span class=cl><span class=c1>// If buf != nil, the compiler has determined that the result does not
</span></span></span><span class=line><span class=cl><span class=c1>// escape the calling function, so the string data can be stored in buf
</span></span></span><span class=line><span class=cl><span class=c1>// if small enough.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>concatstrings</span><span class=p>(</span><span class=nx>buf</span> <span class=o>*</span><span class=nx>tmpBuf</span><span class=p>,</span> <span class=nx>a</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>idx</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=nx>count</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>x</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>a</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>l</span><span class=o>+</span><span class=nx>n</span> <span class=p>&lt;</span> <span class=nx>l</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;string concatenation too long&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span> <span class=o>+=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>		<span class=nx>count</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=nx>idx</span> <span class=p>=</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>count</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If there is just one string and either it is not on the stack
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// or our result does not escape the calling frame (buf != nil),
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// then we can return that string directly.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>count</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>buf</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=p>!</span><span class=nf>stringDataOnStack</span><span class=p>(</span><span class=nx>a</span><span class=p>[</span><span class=nx>idx</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>a</span><span class=p>[</span><span class=nx>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>b</span> <span class=o>:=</span> <span class=nf>rawstringtmp</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=nx>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>x</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>a</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>b</span><span class=p>,</span> <span class=nx>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span> <span class=p>=</span> <span class=nx>b</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>x</span><span class=p>):]</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>该函数会计算出最终字符串的长度，一次分配内存空间给目标串，再把待拼接字符串依次拷贝到目标串</p><ul><li>通过<code>strings.Builder</code> 高效构建字符串</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sb</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nx>Builder</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>sb</span><span class=p>.</span><span class=nf>Grow</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>sb</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>sb</span><span class=p>.</span><span class=nf>WriteByte</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>sb</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=s>&#34;world&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>sb</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// hello world
</span></span></span></code></pre></td></tr></table></div></div><p><code>strings.Builder</code> 用一个字节切片作为容器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Builder</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>addr</span> <span class=o>*</span><span class=nx>Builder</span> <span class=c1>// of receiver, to detect copies by value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>buf</span>  <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过提前预估容量，调用<code>Grow</code>函数，可以有效的减少内存分配次数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Builder</span><span class=p>)</span> <span class=nf>grow</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>buf</span><span class=p>),</span> <span class=mi>2</span><span class=o>*</span><span class=nb>cap</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>buf</span><span class=p>)</span><span class=o>+</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=nx>b</span><span class=p>.</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nx>buf</span> <span class=p>=</span> <span class=nx>buf</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Builder</span><span class=p>)</span> <span class=nf>Grow</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nf>copyCheck</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>n</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;strings.Builder.Grow: negative count&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>buf</span><span class=p>)</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>buf</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>n</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nf>grow</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>String</code>函数通过指针强制转换避免了从字节切片到字符串的内存拷贝</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// String returns the accumulated string.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>Builder</span><span class=p>)</span> <span class=nf>String</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=kt>string</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>b</span><span class=p>.</span><span class=nx>buf</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=map>map</h2><p>Go 语言中的 map 实现为 hash 表，运行时结构为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// A header for a Go map.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>hmap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Make sure this stays in sync with the compiler&#39;s definition.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>count</span>     <span class=kt>int</span> <span class=c1>// # live cells == size of map.  Must be first (used by len() builtin)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>flags</span>     <span class=kt>uint8</span>
</span></span><span class=line><span class=cl>	<span class=nx>B</span>         <span class=kt>uint8</span>  <span class=c1>// log_2 of # of buckets (can hold up to loadFactor * 2^B items)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>noverflow</span> <span class=kt>uint16</span> <span class=c1>// approximate number of overflow buckets; see incrnoverflow for details
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hash0</span>     <span class=kt>uint32</span> <span class=c1>// hash seed
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>buckets</span>    <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// array of 2^B Buckets. may be nil if count==0.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>oldbuckets</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span> <span class=c1>// previous bucket array of half the size, non-nil only when growing
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nevacuate</span>  <span class=kt>uintptr</span>        <span class=c1>// progress counter for evacuation (buckets less than this have been evacuated)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>extra</span> <span class=o>*</span><span class=nx>mapextra</span> <span class=c1>// optional fields
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可用 <code>len</code> 获取 map 的长度</p><p>map 中实际存储键值对的容器是<code>bucket</code>(桶)，运行时结构为<code>bmap</code>,一个 bucket 可以存放 8 个键值对</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>bmap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>topbits</span>  <span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=kt>uint8</span>
</span></span><span class=line><span class=cl>    <span class=nx>keys</span>     <span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=nx>keytype</span>
</span></span><span class=line><span class=cl>    <span class=nx>values</span>   <span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=nx>valuetype</span>
</span></span><span class=line><span class=cl>    <span class=nx>pad</span>      <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl>    <span class=nx>overflow</span> <span class=kt>uintptr</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>map 的内存结构如下图：</p><p><img src=/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/map_m.png width=2248 height=1558 srcset="/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/map_m_huafb75758b2d5fe0a0e483383b115e5e2_242913_480x0_resize_box_3.png 480w, /p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/map_m_huafb75758b2d5fe0a0e483383b115e5e2_242913_1024x0_resize_box_3.png 1024w" loading=lazy alt=map内存结构 class=gallery-image data-flex-grow=144 data-flex-basis=346px></p><h3 id=初始化-1>初始化</h3><p>未初始化的 map 等于<code>nil</code>,对其进行写操作会报异常,我们申明的 map 类型变量实际上是 <code>*hmap</code> 类型的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>m1</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%p,len:%d,size:%v,is nil:%t\n&#34;</span><span class=p>,</span> <span class=nx>m1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>m1</span><span class=p>),</span> <span class=nx>unsafe</span><span class=p>.</span><span class=nf>Sizeof</span><span class=p>(</span><span class=nx>m1</span><span class=p>),</span> <span class=nx>m1</span> <span class=o>==</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// 0x0,len:0,size:8,is nil:true
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>m1</span><span class=p>[</span><span class=s>&#34;a&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>m1</span><span class=p>[</span><span class=s>&#34;a&#34;</span><span class=p>]=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// panic: assignment to entry in nil map
</span></span></span></code></pre></td></tr></table></div></div><h4 id=字面量初始化>字面量初始化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span><span class=o>:=</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=mi>1</span><span class=p>:</span><span class=s>&#34;abc&#34;</span><span class=p>,</span><span class=mi>2</span><span class=p>:</span><span class=s>&#34;cbe&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=make初始化><code>make</code>初始化</h4><p>可以指定初始容量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m1</span><span class=o>:=</span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>m2</span><span class=o>:=</span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>无论是字面量还是<code>make</code>函数，都会被 Go 语言编译器在类型检查期间转化为<code>runtime.makemap</code> 调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>makemap</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>maptype</span><span class=p>,</span> <span class=nx>hint</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>h</span> <span class=o>*</span><span class=nx>hmap</span><span class=p>)</span> <span class=o>*</span><span class=nx>hmap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mem</span><span class=p>,</span> <span class=nx>overflow</span> <span class=o>:=</span> <span class=nx>math</span><span class=p>.</span><span class=nf>MulUintptr</span><span class=p>(</span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>hint</span><span class=p>),</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bucket</span><span class=p>.</span><span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>overflow</span> <span class=o>||</span> <span class=nx>mem</span> <span class=p>&gt;</span> <span class=nx>maxAlloc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>hint</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// initialize Hmap
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>h</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>hmap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span><span class=p>.</span><span class=nx>hash0</span> <span class=p>=</span> <span class=nf>fastrand</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Find the size parameter B which will hold the requested # of elements.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// For hint &lt; 0 overLoadFactor returns false since hint &lt; bucketCnt.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>B</span> <span class=o>:=</span> <span class=nb>uint8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nf>overLoadFactor</span><span class=p>(</span><span class=nx>hint</span><span class=p>,</span> <span class=nx>B</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>B</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span><span class=p>.</span><span class=nx>B</span> <span class=p>=</span> <span class=nx>B</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// allocate initial hash table
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// if B == 0, the buckets field is allocated lazily later (in mapassign)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If hint is large zeroing this memory could take a while.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>h</span><span class=p>.</span><span class=nx>B</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>nextOverflow</span> <span class=o>*</span><span class=nx>bmap</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>.</span><span class=nx>buckets</span><span class=p>,</span> <span class=nx>nextOverflow</span> <span class=p>=</span> <span class=nf>makeBucketArray</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nx>B</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>nextOverflow</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>h</span><span class=p>.</span><span class=nx>extra</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>mapextra</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>h</span><span class=p>.</span><span class=nx>extra</span><span class=p>.</span><span class=nx>nextOverflow</span> <span class=p>=</span> <span class=nx>nextOverflow</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>h</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>总结一下，初始化过程包括：</p><ul><li>创建 hmap 变量</li><li>初始化 hmap 中的字段（主要是 bucket 数组）</li></ul><h3 id=访问>访问</h3><ul><li>直接访问,如果 key 不存在则返回元素零值</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span><span class=o>:=</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=mi>1</span><span class=p>:</span><span class=s>&#34;dog&#34;</span><span class=p>,</span><span class=mi>2</span><span class=p>:</span><span class=s>&#34;cat&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>m</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>comma_ok 形式，ok 字段表示 key 是否存在</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span><span class=o>:=</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=mi>1</span><span class=p>:</span><span class=s>&#34;dog&#34;</span><span class=p>,</span><span class=mi>2</span><span class=p>:</span><span class=s>&#34;cat&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>v</span><span class=p>,</span><span class=nx>ok</span><span class=o>:=</span><span class=nx>m</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>这两种访问对应运行时函数<code>runtime.mapaccess1</code> 和<code>runtime.mapaccess2</code> 函数。</p><p>key的查找过程如下图：</p><p><img src=/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/map_key_find.png width=1766 height=2248 srcset="/p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/map_key_find_hu59b88d78eb9462fd629b72cb34d18d9e_181006_480x0_resize_box_3.png 480w, /p/go-%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/map_key_find_hu59b88d78eb9462fd629b72cb34d18d9e_181006_1024x0_resize_box_3.png 1024w" loading=lazy alt=key查找过程 class=gallery-image data-flex-grow=78 data-flex-basis=188px></p><ul><li>计算key的hash</li><li>根据hash的低B位在bucket数组中找到bucket</li><li>根据hash的高8位与bucket中的tophash数组进行比对，找到key的位置</li></ul><h3 id=遍历>遍历</h3><p>可以通过 <code>range</code> 关键字遍历 map,注意遍历的顺序是随机的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m2</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=mi>1</span><span class=p>:</span> <span class=s>&#34;cat&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mi>2</span><span class=p>:</span> <span class=s>&#34;dog&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>m2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>k</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// output
</span></span></span><span class=line><span class=cl><span class=c1>// 1 cat
</span></span></span><span class=line><span class=cl><span class=c1>// 2 dog
</span></span></span></code></pre></td></tr></table></div></div><p>编译器会重写<code>for-range</code>循环，将其换为对运行时函数<code>runntime.mapiterinit</code>和<code>runtime.mapiternext</code>的调用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ha</span> <span class=o>:=</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl><span class=nx>hit</span> <span class=o>:=</span> <span class=nf>hiter</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>th</span> <span class=o>:=</span> <span class=nx>hit</span><span class=p>.</span><span class=nx>Type</span>
</span></span><span class=line><span class=cl><span class=nf>mapiterinit</span><span class=p>(</span><span class=nf>typename</span><span class=p>(</span><span class=nx>t</span><span class=p>),</span> <span class=nx>ha</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>hit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>;</span> <span class=nx>hit</span><span class=p>.</span><span class=nx>key</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>;</span> <span class=nf>mapiternext</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>hit</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span> <span class=o>:=</span> <span class=o>*</span><span class=nx>hit</span><span class=p>.</span><span class=nx>key</span>
</span></span><span class=line><span class=cl>    <span class=nx>val</span> <span class=o>:=</span> <span class=o>*</span><span class=nx>hit</span><span class=p>.</span><span class=nx>val</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>遍历的过程就是遍历每个bucket及其overflow bucket的过程，由于扩容的存在，会涉及到遍历新老bucket的问题。
遍历过程：</p><ul><li>创建一个迭代器并初始化（主要是确定初始bucket和初始cell）</li><li>不断地获取下一个bucket进行遍历，直到回到起始bucket</li></ul><p>此过程的难点在于2 倍扩容时，老 bucket 会分裂到 2 个新 bucket 中去。而遍历操作，会按照新 bucket 的序号顺序进行，碰到老 bucket 未搬迁的情况时，要在老 bucket 中找到将来要搬迁到新 bucket 来的 key。</p><h3 id=写入>写入</h3><p>可以通过下标的方式进行写入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span><span class=o>:=</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=mi>1</span><span class=p>:</span><span class=s>&#34;abc&#34;</span><span class=p>,</span><span class=mi>2</span><span class=p>:</span><span class=s>&#34;cbe&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>[</span><span class=mi>1</span><span class=p>]=</span><span class=s>&#34;ccc&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>[</span><span class=mi>3</span><span class=p>]=</span><span class=s>&#34;ddd&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>编译器会将其转换为对运行时函数<code>runtime.mapassign</code>的调用，写入分为更新和新增，无论哪种都得先查找 key 所在的位置，查找的过程同访问的过程，如果查找到 key,则对其 value 进行更新，否则新增 kv。新增 kv 会进行扩容检查，如果满足条件，会进行扩容。</p><h3 id=删除>删除</h3><p>可通过内置函数 <code>delete</code> 删除数组元素</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>m</span><span class=o>:=</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span><span class=mi>1</span><span class=p>:</span><span class=s>&#34;aaa&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>delete</span><span class=p>(</span><span class=nx>m</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>运行时实际调用的函数为<code>runtime.mapdelete</code></p><p>删除的过程:</p><ul><li>判断flags标记，如果有写标记，则直接报异常"concurrent map writes"</li><li>根据key的hash找到bucket，如果map处于扩容中，则触发一次搬迁操作</li><li>找到key和value并清空，并设置对应tophash为emptyOne</li><li>将count减一</li></ul><h3 id=扩容-1>扩容</h3><p>底层容器为数组，所以会涉及到扩容。扩容操作会涉及所有 bucket 的迁移，这是一个比较耗时的过程，所以扩容实现为渐进式扩容，当扩容开始后，每次对 map 的写操作会搬迁 1~2 个 bucket。</p><ul><li>当负载因子超过6.5时会发生翻倍扩容</li><li>当溢出桶的数量过多时会发生等量扩容</li></ul><h2 id=参考>参考</h2><ul><li><a class=link href=https://draveness.me/golang/ target=_blank rel=noopener>Go 语言设计与实现</a></li><li><a class=link href=https://golang.design/go-questions/ target=_blank rel=noopener>Go 程序员面试宝典</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/golang/>golang</a>
<a href=/tags/array/>array</a>
<a href=/tags/slice/>slice</a>
<a href=/tags/string/>string</a>
<a href=/tags/map/>map</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/go%E7%A8%8B%E5%BA%8F%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA/><div class=article-details><h2 class=article-title>go程序优雅退出</h2></div></a></article><article><a href=/p/net/http%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/><div class=article-details><h2 class=article-title>net/http源码分析</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=cloudjjcc/cloudjjcc.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyMzAzOTgyODU=" data-category=Announcements data-category-id=DIC_kwDODbuZTc4CZbH_ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script>
<script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2019 -
2023 cloudjjcc</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>